"macro setLK2"
" setlk(arg1) - set up lock parameters "
" first argument (required) - lock solvent "
 
" this macro provides various approaches to adjusting locking	"
" and shimming as a function of solvent.			"
" removing quotation marks from around different parts of the	"
" macro will put that particular secton into effect.		"
" if no changes are made, it is required that alock=s in	"
" parameter sets which are used.				"

" if solvent is not changed, current lock parameters are used.	"
" any shimming is controlled by the method specified in		"
" stdpar/h1 or stdpar/c13					"

if ($# <> 1) then
   write('error','The solvent must be supplied as an argument to setlk')
   return
endif
"exists(systemdir+'/acqqueue/lastlk','file'):$e "
"if ($e > 0.5) then "
"  lookup('file',systemdir+'/acqqueue/lastlk','was','read'):lastlk "
"else "
"  lastlk='' "
"endif "
"if ($1 = lastlk) then "
"   alock='y' "
"   return "
"endif "
"lastlk = $1 "     "the new solvent will be the new 'last' solvent"
"write('reset',systemdir+'/acqqueue/lastlk') "
"write('file',systemdir+'/acqqueue/lastlk','last lock solvent was %s',lastlk) "

"if (auto='n') then "
   "exit if system is already locked"
"    readlk:$locklevel "
"    if ($locklevel>20) then return endif "
"endif "

"if automatic determination of lockpower and lockgain is desired,"
"make sure that stdpar.h and stdpar.c have alock=s              "
 format($1,'lower'):$solv

"if solvent-based shim sets are desired for new solvents,store	"
"appropriate shim sets (if you use more than one probe you 	"
"should have a shims library for each).				"
"then remove quotes from the next line                          "
"not needed for gradient shimming (wshim='g')                   "
"first we look for solvent name (lower case), then cdcl3, else skip"
"exists(userdir+'/shims/'+$solv,'file'):$e"
"exists(systemdir+'/shims/'+$solv,'file'):$e1"
"if ($e>0.5)or($e1>0.5) then"
"   rts($solv)"
"else"
"   exists(userdir+'/shims/cdcl3','file'):$e"
"   exists(systemdir+'/shims/cdcl3','file'):$e1"
"   if ($e>0.5)or($e1>0.5) then"
"      rts('cdcl3')"
"   endif"
"endif"		" if none exist continue with current shims"

"if shim method is to be determined by solvent, then remove the"
" quotes in next lines (you must create the methods given)"
"not used by gradient shimming"
"if ($solv='acetone')or($solv='cd3od')or($solv='cd2cl2') then method='longt1'"
"else if ($solv='c6d6')or($solv='cdcl3') then method='medt1'"
"else if ($solv='dmso')or($solv='d2o') then method='shrtt1'"
"else method='stdt1' endif endif endif"

"if you prefer to explicitly set lockpower/lockgain for each solvent,"
"the lines below must be updated to correspond to"
"the non-saturating values for the spectrometer in use. this"
"can speed up the automatic locking process."
"z0 can also be set (for weak locks), along with lockpower/lockgain"
"z0 should be set for deuterium gradient shimming"
"if $solv='cdcl3'  then lockpower=22 lockgain=70 else"
"if $solv='d2o'    then lockpower=22 lockgain=70 else"
"if $solv='acetone' then lockpower=15 lockgain=40 else"
"if $solv='dmso'   then lockpower=20 lockgain=50 else"
"if $solv='c6d6'   then lockpower=20 lockgain=50 else"
"lockpower=25 lockgain=50 endif endif endif endif endif"
"alock='y'"

"Alternatively z0, lockpower and lockgain can be set in the probes file"
"  and called by the getparam macro "
"$z0=0 $lkpwr=0 $lkgn=0 "
"getparam('z0_'+$solv,'lk'):$z0 if $z0 <> 0 then z0=$z0 endif "
"getparam('pwr_'+$solv,'lk'):$lkpwr if $lkpwr <> 0 then lockpower=$lkpwr endif "
"getparam('gn_'+$solv,'lk'):$lkgn if $lkgn <> 0 then lockgain=$lkgn endif "
"alock='y' "

